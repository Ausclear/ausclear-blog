<!DOCTYPE html>
<html lang="en-AU">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ask AusClear - Chat Widget</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --navy-primary: #002147;
      --navy-secondary: #003366;
      --gold: #f1c40f;
      --red: #dc2626;
      --green: #10b981;
      --yellow: #f59e0b;
      --white: #ffffff;
      --gray-50: #f8fafc;
      --gray-100: #f1f5f9;
      --gray-200: #e2e8f0;
      --gray-600: #475569;
      --text: #333333;
      --border: #e1e5e9;
      --bg: #fafbfc;
    }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: transparent; }

    /* ============= LAUNCHER ============= */
    .ac-launcher {
      position: fixed; bottom: 24px; right: 24px; width: 64px; height: 64px;
      border-radius: 50%; background: linear-gradient(135deg, var(--navy-primary), var(--navy-secondary));
      box-shadow: 0 8px 24px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;
      cursor: pointer; z-index: 999999; transition: all 0.3s ease; border: 2px solid var(--gold);
    }
    .ac-launcher:hover { transform: scale(1.08); box-shadow: 0 0 20px rgba(241,196,15,0.6); }
    .ac-launcher svg { width: 32px; height: 32px; fill: var(--gold); }

    /* ============= WINDOW ============= */
    .ac-window {
      position: fixed; bottom: 104px; right: 24px; width: 420px; height: 650px;
      background: var(--white); border-radius: 16px; box-shadow: 0 25px 50px rgba(0,0,0,0.4);
      display: none; flex-direction: column; overflow: hidden; z-index: 9999999; border: 1px solid var(--gray-200);
    }
    .ac-window.open { display: flex; }

    /* ============= HEADER ============= */
    .ac-header {
      background: linear-gradient(135deg, rgba(0,33,71,0.95), rgba(0,51,102,0.9));
      padding: 20px 24px; display: flex; justify-content: space-between; align-items: center;
      flex-shrink: 0;
    }
    .ac-header-content { display: flex; align-items: center; gap: 12px; }
    .ac-header-icon {
      width: 40px; height: 40px; background: rgba(241,196,15,0.15); border-radius: 10px;
      display: flex; align-items: center; justify-content: center; border: 1px solid rgba(241,196,15,0.3);
    }
    .ac-header-icon svg { width: 24px; height: 24px; fill: var(--gold); }
    .ac-header h3 { font-size: 18px; font-weight: 700; color: var(--white); margin-bottom: 4px; }
    .ac-header p { font-size: 13px; color: rgba(255,255,255,0.8); }

    .ac-close {
      background: rgba(255,255,255,0.1); border: none; width: 40px; height: 40px; border-radius: 50%;
      cursor: pointer; color: var(--white); font-size: 28px; display: flex; align-items: center; justify-content: center;
      transition: all 0.3s ease;
    }
    .ac-close:hover { background: rgba(255,255,255,0.2); transform: rotate(90deg); }

    /* ============= PRECHAT ============= */
    .ac-prechat { 
      padding: 32px; overflow-y: auto; background: var(--white);
      flex: 1; min-height: 0;
    }
    .ac-prechat h4 { font-size: 22px; margin-bottom: 12px; color: var(--navy-primary); font-weight: 700; }
    .ac-prechat > p { font-size: 15px; color: var(--gray-600); margin-bottom: 28px; line-height: 1.6; }
    .ac-field { margin-bottom: 20px; }
    .ac-field label {
      display: block; margin-bottom: 8px; font-size: 14px; color: var(--navy-primary);
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .ac-field .req { color: var(--red); margin-left: 3px; }
    .ac-field input, .ac-field select {
      width: 100%; padding: 16px; border-radius: 8px; background: var(--bg);
      border: 2px solid var(--border); color: var(--text); font-size: 16px; font-family: inherit;
      transition: all 0.3s ease;
    }
    .ac-field input:focus, .ac-field select:focus {
      outline: none; border-color: var(--navy-primary); background: var(--white);
      box-shadow: 0 0 0 3px rgba(0,33,71,0.1);
    }
    .ac-start {
      width: 100%; padding: 16px; background: linear-gradient(135deg, var(--navy-primary), var(--navy-secondary));
      border: none; border-radius: 8px; color: var(--white); font-weight: 700; font-size: 16px;
      cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,33,71,0.3);
      text-transform: uppercase; letter-spacing: 0.5px; margin-top: 12px;
    }
    .ac-start:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,33,71,0.4); }
    .ac-start:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.6; }

    /* ============= CHAT VIEW ============= */
    .ac-chat { 
      display: none; flex-direction: column; background: var(--white); position: relative;
      flex: 1; min-height: 0;
    }
    .ac-chat.active { display: flex; }

    /* ============= MESSAGES AREA - SCROLLABLE ============= */
    .ac-messages { 
      overflow-y: auto; 
      padding: 20px; 
      scroll-behavior: smooth;
      flex: 1;
      min-height: 0;
    }
    .ac-msg { margin-bottom: 16px; display: flex; animation: msgSlide 0.3s ease; }
    @keyframes msgSlide { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .ac-msg.user { justify-content: flex-end; }
    .ac-msg-content { max-width: 80%; padding: 14px 18px; border-radius: 12px; font-size: 15px; line-height: 1.6; }
    .ac-msg.user .ac-msg-content {
      background: linear-gradient(135deg, var(--navy-primary), var(--navy-secondary));
      color: var(--white); border-bottom-right-radius: 4px;
    }
    .ac-msg.ai .ac-msg-content, .ac-msg.admin .ac-msg-content, .ac-msg.system .ac-msg-content {
      background: var(--gray-50); color: var(--text); border: 1px solid var(--gray-200); border-bottom-left-radius: 4px;
    }

    /* ============= INPUT AREA - FIXED HEIGHT, ALWAYS VISIBLE ============= */
    .ac-input-area { 
      padding: 20px 16px;
      background: var(--white);
      border-top: 2px solid var(--gray-200);
      display: flex;
      gap: 12px;
      align-items: center;
      flex-shrink: 0;
    }
    .ac-input {
      flex: 1;
      padding: 16px 18px;
      background: var(--bg);
      border-radius: 8px;
      border: 2px solid var(--border);
      color: var(--text);
      font-size: 16px;
      font-family: inherit;
      transition: all 0.3s ease;
    }
    .ac-input:focus { outline: none; border-color: var(--navy-primary); background: var(--white); }
    .ac-send {
      background: linear-gradient(135deg, var(--navy-primary), var(--navy-secondary));
      border: none;
      border-radius: 8px;
      padding: 16px 28px;
      font-weight: 700;
      cursor: pointer;
      color: var(--white);
      font-size: 16px;
      transition: all 0.3s ease;
      text-transform: uppercase;
    }
    .ac-send:hover { transform: translateY(-2px); }
    .ac-send:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    /* ============= MOBILE ============= */
    @media (max-width: 768px) {
      .ac-window { width: 100%; height: 100%; right: 0; left: 0; bottom: 0; top: 0; border-radius: 0; border: none; }
      .ac-launcher { bottom: 16px; right: 16px; width: 52px; height: 52px; }
    }
  </style>
</head>
<body>

<div class="ac-launcher" id="launcher">
  <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/><circle cx="8" cy="10" r="1.5"/><circle cx="12" cy="10" r="1.5"/><circle cx="16" cy="10" r="1.5"/></svg>
</div>

<div class="ac-window" id="window">
  <div class="ac-header">
    <div class="ac-header-content">
      <div class="ac-header-icon">
        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
      </div>
      <div>
        <h3>Ask AusClear</h3>
        <p>Security Clearance Experts</p>
      </div>
    </div>
    <button class="ac-close" id="closeBtn">Ã—</button>
  </div>

  <!-- PRECHAT FORM -->
  <div class="ac-prechat" id="prechat">
    <h4>ðŸ‘‹ Welcome to AusClear</h4>
    <p>Start a conversation with Trigger, our AI assistant who can help with your security clearance enquiry.</p>

    <div class="ac-field">
      <label>Your Name <span class="req">*</span></label>
      <input type="text" id="nameInput" placeholder="e.g. John Smith">
    </div>

    <div class="ac-field">
      <label>Email Address <span class="req">*</span></label>
      <input type="email" id="emailInput" placeholder="e.g. john.smith@example.com">
    </div>

    <div class="ac-field">
      <label>Clearance Level <span class="req">*</span></label>
      <select id="clearanceLevel">
        <option value="">Select clearance level...</option>
        <option value="Baseline">Baseline</option>
        <option value="NV1">NV1</option>
        <option value="NV2">NV2</option>
        <option value="Unsure">Unsure / Need Advice</option>
      </select>
    </div>

    <button class="ac-start" id="startBtn" disabled>Start Chat</button>
  </div>

  <!-- CHAT VIEW -->
  <div class="ac-chat" id="chat">
    <div class="ac-messages" id="messages"></div>
    
    <div class="ac-input-area">
      <input type="text" class="ac-input" id="userInput" placeholder="Type your message...">
      <button class="ac-send" id="sendBtn">Send</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(function() {
  const SUPABASE_URL = "https://qraxdkzmteogkbfatvir.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFyYXhka3ptdGVvZ2tiZmF0dmlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1OTk5MjEsImV4cCI6MjA3OTE3NTkyMX0.WqCGjBEiLgmqbaGmc8Z87CeqY-l_DBR3Gj9VQ4sujks";
  // PRODUCTION API ENDPOINTS
  const AI_ENDPOINT = window.location.origin + "/api/ai";
  const QUEUE_STATUS_ENDPOINT = window.location.origin + "/api/queue/status";
  
  const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  var sessionId = null;
  var launcher = document.getElementById('launcher');
  var chatWindow = document.getElementById('window');
  var closeBtn = document.getElementById('closeBtn');
  var prechat = document.getElementById('prechat');
  var chat = document.getElementById('chat');
  var startBtn = document.getElementById('startBtn');
  var nameInput = document.getElementById('nameInput');
  var emailInput = document.getElementById('emailInput');
  var clearanceLevelInput = document.getElementById('clearanceLevel');
  var messages = document.getElementById('messages');
  var userInput = document.getElementById('userInput');
  var sendBtn = document.getElementById('sendBtn');
  var isOpen = false;

  function updateStartButton() {
    var nameOk = nameInput.value.trim().length > 0;
    var emailOk = emailInput.value.trim().length > 0;
    var clearanceOk = clearanceLevelInput.value.length > 0;
    startBtn.disabled = !(nameOk && emailOk && clearanceOk);
  }

  nameInput.addEventListener('input', updateStartButton);
  emailInput.addEventListener('input', updateStartButton);
  clearanceLevelInput.addEventListener('change', updateStartButton);

  launcher.addEventListener('click', function() {
    if (isOpen) {
      chatWindow.classList.remove('open');
      isOpen = false;
    } else {
      chatWindow.classList.add('open');
      isOpen = true;
    }
  });

  closeBtn.addEventListener('click', function() {
    chatWindow.classList.remove('open');
    isOpen = false;
  });

  startBtn.addEventListener('click', async function() {
    var name = nameInput.value.trim();
    var email = emailInput.value.trim();
    var clearance = clearanceLevelInput.value;
    
    if (!name || !email || !clearance) {
      alert('Please complete all required fields.');
      return;
    }

    const { data, error } = await supabaseClient
      .from("live_chat_sessions")
      .insert({
        user_name: name,
        email: email,
        intake_clearance_type: clearance,
        status: "open",
        channel: "web"
      })
      .select()
      .single();

    if (error) {
      alert("Failed to create session. Please try again.");
      return;
    }

    sessionId = data.id;
    prechat.style.display = 'none';
    chat.classList.add('active');
    
    addMessage('ai', 'Hi ' + name + '! How can I help you with your ' + clearance + ' clearance today?');
    userInput.focus();
  });

  function addMessage(sender, text) {
    var div = document.createElement('div');
    div.className = 'ac-msg ' + sender;
    var content = document.createElement('div');
    content.className = 'ac-msg-content';
    content.textContent = text;
    div.appendChild(content);
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }

  function sendMessage() {
    var text = userInput.value.trim();
    if (!text) return;
    userInput.value = '';
    addMessage('user', text);
    // Send to API here
  }

  sendBtn.addEventListener('click', sendMessage);
  userInput.addEventListener('keypress', function(e) { 
    if (e.key === 'Enter') sendMessage(); 
  });

})();
</script>
</body>
</html>
