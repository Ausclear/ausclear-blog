<!DOCTYPE html>
<html lang="en-AU">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ask Clearance First - Chat Widget</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --navy-primary: #002147;
      --navy-secondary: #003366;
      --gold: #f1c40f;
      --red: #dc2626;
      --green: #10b981;
      --yellow: #f59e0b;
      --white: #ffffff;
      --gray-50: #f8fafc;
      --gray-100: #f1f5f9;
      --gray-200: #e2e8f0;
      --gray-600: #475569;
      --text: #333333;
      --border: #e1e5e9;
      --bg: #fafbfc;
    }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: #f5f5f5; }

    /* ============= LAUNCHER ============= */
    .ac-launcher {
      position: fixed; bottom: 24px; right: 24px; width: 64px; height: 64px;
      border-radius: 50%; background: linear-gradient(135deg, var(--navy-primary), var(--navy-secondary));
      box-shadow: 0 8px 24px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;
      cursor: pointer; z-index: 999999; transition: all 0.3s ease; border: 2px solid var(--gold);
    }
    .ac-launcher:hover { transform: scale(1.08); box-shadow: 0 0 20px rgba(241,196,15,0.6); }
    .ac-launcher svg { width: 32px; height: 32px; fill: var(--gold); }

    /* ============= WINDOW ============= */
    .ac-window {
      position: fixed; bottom: 104px; right: 24px; width: 420px; height: 650px;
      background: var(--white); border-radius: 16px; box-shadow: 0 25px 50px rgba(0,0,0,0.4);
      display: none; flex-direction: column; overflow: hidden; z-index: 9999999; border: 1px solid var(--gray-200);
    }
    .ac-window.open { display: flex; }

    /* ============= HEADER ============= */
    .ac-header {
      background: linear-gradient(135deg, rgba(0,33,71,0.95), rgba(0,51,102,0.9));
      padding: 20px 24px; display: flex; justify-content: space-between; align-items: center;
      flex-shrink: 0;
    }
    .ac-header-content { display: flex; align-items: center; gap: 12px; }
    .ac-header-icon {
      width: 40px; height: 40px; background: rgba(241,196,15,0.15); border-radius: 10px;
      display: flex; align-items: center; justify-content: center; border: 1px solid rgba(241,196,15,0.3);
    }
    .ac-header-icon svg { width: 24px; height: 24px; fill: var(--gold); }
    .ac-header h3 { font-size: 18px; font-weight: 700; color: var(--white); margin-bottom: 4px; }
    .ac-header p { font-size: 13px; color: rgba(255,255,255,0.8); }

    .ac-traffic-light {
      display: none; align-items: center; gap: 8px; padding: 6px 10px;
      background: transparent; border-radius: 20px; border: none; flex-direction: column;
    }
    .ac-traffic-light.active { display: flex; }
    .ac-traffic-dots { display: flex; align-items: center; gap: 8px; }
    .ac-traffic-status {
      font-size: 11px; color: rgba(255,255,255,0.95); font-weight: 500;
      text-align: center; margin-top: 4px; letter-spacing: 0.3px; text-shadow: 0 1px 2px rgba(0,0,0,0.4);
    }
    .ac-traffic-dot {
      width: 14px; height: 14px; border-radius: 50%; background: rgba(200,200,200,0.3);
      border: 1px solid rgba(0,0,0,0.1); transition: all 0.3s ease;
    }
    .ac-traffic-dot.red { 
      background: #ef4444; box-shadow: 0 0 15px #ef4444, 0 0 25px rgba(239,68,68,0.5); border-color: #dc2626;
    }
    .ac-traffic-dot.yellow { 
      background: #fbbf24; box-shadow: 0 0 15px #fbbf24, 0 0 25px rgba(251,191,36,0.5); border-color: #f59e0b;
    }
    .ac-traffic-dot.green { 
      background: #22c55e; box-shadow: 0 0 15px #22c55e, 0 0 25px rgba(34,197,94,0.5); border-color: #16a34a;
    }
    .ac-traffic-dot.active { animation: pulse 1.5s ease-in-out infinite; }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); filter: brightness(1); }
      50% { opacity: 0.8; transform: scale(1.15); filter: brightness(1.3); }
    }

    .ac-close {
      background: rgba(255,255,255,0.1); border: none; width: 40px; height: 40px; border-radius: 50%;
      cursor: pointer; color: var(--white); font-size: 28px; display: flex; align-items: center; justify-content: center;
      transition: all 0.3s ease;
    }
    .ac-close:hover { background: rgba(255,255,255,0.2); transform: rotate(90deg); }

    /* ============= PRECHAT ============= */
    .ac-prechat { 
      padding: 32px; overflow-y: auto; background: var(--white);
      flex: 1; min-height: 0;
    }
    .ac-prechat h4 { font-size: 22px; margin-bottom: 12px; color: var(--navy-primary); font-weight: 700; }
    .ac-prechat > p { font-size: 15px; color: var(--gray-600); margin-bottom: 28px; line-height: 1.6; }
    .ac-field { margin-bottom: 20px; }
    .ac-field label {
      display: block; margin-bottom: 8px; font-size: 14px; color: var(--navy-primary);
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .ac-field .req { color: var(--red); margin-left: 3px; }
    .ac-field input, .ac-field select {
      width: 100%; padding: 16px; border-radius: 8px; background: var(--bg);
      border: 2px solid var(--border); color: var(--text); font-size: 16px; font-family: inherit;
      transition: all 0.3s ease;
    }
    .ac-field input:focus, .ac-field select:focus {
      outline: none; border-color: var(--navy-primary); background: var(--white);
      box-shadow: 0 0 0 3px rgba(0,33,71,0.1);
    }
    .ac-field input.valid { border-color: #28a745; }
    .ac-field input.invalid { border-color: var(--red); }
    .ac-validation { display: none; align-items: center; gap: 8px; margin-top: 8px; font-size: 13px; font-weight: 500; }
    .ac-validation.valid { color: #28a745; display: flex; }
    .ac-validation.invalid { color: var(--red); display: flex; }
    .ac-validation.checking { color: #ffc107; display: flex; }
    .ac-help { margin-top: 6px; font-size: 12px; color: #666; line-height: 1.4; }
    .ac-start {
      width: 100%; padding: 16px; background: linear-gradient(135deg, var(--navy-primary), var(--navy-secondary));
      border: none; border-radius: 8px; color: var(--white); font-weight: 700; font-size: 16px;
      cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,33,71,0.3);
      text-transform: uppercase; letter-spacing: 0.5px; margin-top: 12px;
    }
    .ac-start:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,33,71,0.4); }
    .ac-start:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.6; }

    /* ============= CHAT VIEW ============= */
    .ac-chat { 
      display: none; flex-direction: column; background: var(--white); position: relative;
      flex: 1; min-height: 0;
    }
    .ac-chat.active { display: flex; }

    /* ============= BOOKING OVERLAY ============= */
    .ac-booking-overlay {
      display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background: var(--white); z-index: 1000; flex-direction: column;
    }
    .ac-booking-overlay.active { display: flex; }
    .ac-booking-header {
      padding: 12px 16px; background: linear-gradient(135deg, var(--navy-primary), var(--navy-secondary));
      display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--gray-200);
    }
    .ac-booking-header h4 { color: var(--white); font-size: 16px; font-weight: 600; margin: 0; }
    .ac-booking-close {
      background: rgba(255,255,255,0.1); border: none; color: var(--white);
      padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 14px;
      font-weight: 500; transition: all 0.3s ease;
    }
    .ac-booking-close:hover { background: rgba(255,255,255,0.2); }
    .ac-booking-frame { flex: 1; border: none; width: 100%; height: 100%; }

    /* ============= MESSAGES AREA - SCROLLABLE ============= */
    .ac-messages { 
      overflow-y: auto; 
      padding: 20px; 
      scroll-behavior: smooth;
      flex: 1;
      min-height: 0;
    }
    .ac-msg { margin-bottom: 16px; display: flex; animation: msgSlide 0.3s ease; }
    @keyframes msgSlide { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .ac-msg.user { justify-content: flex-end; }
    .ac-msg-content { max-width: 80%; padding: 14px 18px; border-radius: 12px; font-size: 15px; line-height: 1.6; }
    .ac-msg.user .ac-msg-content {
      background: linear-gradient(135deg, var(--navy-primary), var(--navy-secondary));
      color: var(--white); border-bottom-right-radius: 4px;
    }
    .ac-msg.ai .ac-msg-content, .ac-msg.admin .ac-msg-content, .ac-msg.system .ac-msg-content {
      background: var(--gray-50); color: var(--text); border: 1px solid var(--gray-200); border-bottom-left-radius: 4px;
    }
    .ac-msg.system .ac-msg-content { background: #fff9e6; border: 1px solid #ffd700; font-style: italic; }
    .ac-msg-content strong { font-weight: 700; }
    .ac-msg.ai .ac-msg-content strong, .ac-msg.admin .ac-msg-content strong, .ac-msg.system .ac-msg-content strong { color: var(--navy-primary); }
    .ac-msg.user .ac-msg-content strong { color: var(--gold); }
    .ac-msg-content p { margin-bottom: 12px; }
    .ac-msg-content p:last-child { margin-bottom: 0; }
    .ac-msg-content ul, .ac-msg-content ol { margin: 8px 0 12px 20px; }
    .ac-msg-content li { margin-bottom: 6px; }
    .ac-sender-name { font-size: 11px; font-weight: 600; margin-bottom: 6px; opacity: 0.9; }
    .ac-msg.ai .ac-sender-name, .ac-msg.admin .ac-sender-name, .ac-msg.system .ac-sender-name { color: var(--navy-primary); }
    .ac-msg.user .ac-sender-name { color: var(--gold); }
    .ac-typing { display: none; padding: 14px 18px; background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: 12px; max-width: 80px; }
    .ac-typing.active { display: block; }
    .ac-typing-dots { display: flex; gap: 5px; }
    .ac-typing-dot { width: 8px; height: 8px; background: var(--gray-600); border-radius: 50%; animation: bounce 1.4s infinite; }
    .ac-typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .ac-typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-10px); } }

    .ac-action-buttons { display: flex; flex-direction: column; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--gray-200); }
    .ac-action-btn {
      padding: 12px 16px; background: var(--white); border: 2px solid var(--navy-primary);
      border-radius: 8px; font-size: 14px; font-weight: 600; color: var(--navy-primary);
      cursor: pointer; transition: all 0.3s ease; width: 100%; text-align: center;
    }
    .ac-action-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, var(--navy-primary), var(--navy-secondary));
      color: var(--white); transform: translateY(-2px);
    }
    .ac-action-btn:disabled { 
      opacity: 0.5; cursor: not-allowed; transform: none;
      background: #f0f0f0; border-color: #ccc; color: #999;
    }

    /* ============= BUTTON ROW - FIXED HEIGHT ============= */
    .ac-button-row {
      padding: 12px 16px;
      background: var(--white);
      border-top: 1px solid var(--gray-200);
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      flex-shrink: 0;
    }
    .ac-hard-btn {
      flex: 1;
      min-width: 100px;
      padding: 10px 12px;
      background: var(--white);
      border: 2px solid var(--navy-primary);
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      color: var(--navy-primary);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .ac-hard-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, var(--navy-primary), var(--navy-secondary));
      color: var(--white);
    }
    .ac-hard-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: #f5f5f5;
      border-color: #ccc;
      color: #666;
    }

    /* ============= INPUT AREA - FIXED HEIGHT, ALWAYS VISIBLE ============= */
    .ac-input-area { 
      padding: 20px 16px;
      background: var(--white);
      border-top: 2px solid var(--gray-200);
      display: flex;
      gap: 12px;
      align-items: center;
      flex-shrink: 0;
    }
    .ac-input {
      flex: 1;
      padding: 16px 18px;
      background: var(--bg);
      border-radius: 8px;
      border: 2px solid var(--border);
      color: var(--text);
      font-size: 16px;
      font-family: inherit;
      transition: all 0.3s ease;
    }
    .ac-input:focus { outline: none; border-color: var(--navy-primary); background: var(--white); }
    .ac-send {
      background: linear-gradient(135deg, var(--navy-primary), var(--navy-secondary));
      border: none;
      border-radius: 8px;
      padding: 16px 28px;
      font-weight: 700;
      cursor: pointer;
      color: var(--white);
      font-size: 16px;
      transition: all 0.3s ease;
      text-transform: uppercase;
    }
    .ac-send:hover { transform: translateY(-2px); }
    .ac-send:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    /* ============= MOBILE ============= */
    @media (max-width: 768px) {
      .ac-window { width: 100%; height: 100%; right: 0; left: 0; bottom: 0; top: 0; border-radius: 0; border: none; }
      .ac-launcher { bottom: 16px; right: 16px; width: 52px; height: 52px; }
      .ac-launcher svg { width: 26px; height: 26px; }
      .ac-header { padding: 12px 16px; }
      .ac-header-icon { width: 32px; height: 32px; }
      .ac-header-icon svg { width: 18px; height: 18px; }
      .ac-header h3 { font-size: 15px; margin-bottom: 2px; }
      .ac-header p { font-size: 11px; }
      .ac-close { width: 32px; height: 32px; font-size: 22px; }
      .ac-prechat { padding: 16px; }
      .ac-messages { padding: 12px; }
      .ac-msg-content { max-width: 88%; padding: 10px 12px; font-size: 13px; }
      .ac-input-area { padding: 10px 12px; gap: 8px; }
      .ac-input { padding: 10px 12px; font-size: 14px; }
      .ac-send { padding: 10px 16px; font-size: 13px; }
    }
  </style>
</head>
<body>

<div class="ac-launcher" id="launcher">
  <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/><circle cx="8" cy="10" r="1.5"/><circle cx="12" cy="10" r="1.5"/><circle cx="16" cy="10" r="1.5"/></svg>
</div>

<div class="ac-window" id="window">
  <div class="ac-header">
    <div class="ac-header-content">
      <div class="ac-header-icon">
        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
      </div>
      <div>
        <h3>Ask Clearance First</h3>
        <p>Security Clearance Experts</p>
      </div>
    </div>

    <div class="ac-traffic-light" id="trafficLight">
      <div class="ac-traffic-dots">
        <div class="ac-traffic-dot" id="redLight"></div>
        <div class="ac-traffic-dot" id="yellowLight"></div>
        <div class="ac-traffic-dot" id="greenLight"></div>
      </div>
      <div class="ac-traffic-status" id="trafficStatus"></div>
    </div>

    <button class="ac-close" id="closeBtn">√ó</button>
  </div>

  <!-- PRECHAT FORM -->
  <div class="ac-prechat" id="prechat">
    <h4>üëã Welcome to Clearance First</h4>
    <p>Start a conversation with Trigger, our AI assistant who can help with your security clearance enquiry.</p>

    <div class="ac-field">
      <label>Your Name <span class="req">*</span></label>
      <input type="text" id="nameInput" placeholder="e.g. John Smith" style="text-transform: capitalize;">
    </div>

    <div class="ac-field">
      <label>Email Address <span class="req">*</span></label>
      <input type="email" id="emailInput" placeholder="e.g. john.smith@example.com">
      <div class="ac-validation" id="emailValidation">
        <i class="fas fa-spinner fa-spin" id="emailSpinner" style="display:none;"></i>
        <i class="fas fa-check-circle" id="emailCheck" style="display:none;"></i>
        <i class="fas fa-exclamation-circle" id="emailError" style="display:none;"></i>
        <span id="emailText"></span>
      </div>
    </div>

    <div class="ac-field">
      <label>Mobile Number</label>
      <input type="tel" id="mobileInput" placeholder="e.g. 0412 345 678">
      <div class="ac-help">Optional - for callback purposes</div>
    </div>

    <div class="ac-field">
      <label>Clearance Level <span class="req">*</span></label>
      <select id="clearanceLevel">
        <option value="">Select clearance level...</option>
        <option value="Baseline">Baseline</option>
        <option value="NV1">NV1</option>
        <option value="NV2">NV2</option>
        <option value="Unsure">Unsure / Need Advice</option>
      </select>
    </div>

    <button class="ac-start" id="startBtn" disabled>Start Chat</button>
  </div>

  <!-- CHAT VIEW -->
  <div class="ac-chat" id="chat">
    <!-- Booking Overlay -->
    <div class="ac-booking-overlay" id="bookingOverlay">
      <div class="ac-booking-header">
        <h4>üìÖ Book a Callback</h4>
        <button class="ac-booking-close" id="closeBooking">Return to Chat</button>
      </div>
      <iframe id="bookingFrame" class="ac-booking-frame" src="" allow="clipboard-write"></iframe>
    </div>

    <!-- Messages Area - SCROLLS -->
    <div class="ac-messages" id="messages">
      <div class="ac-typing" id="typing">
        <div class="ac-typing-dots">
          <div class="ac-typing-dot"></div>
          <div class="ac-typing-dot"></div>
          <div class="ac-typing-dot"></div>
        </div>
      </div>
    </div>

    <!-- Hard-Coded Buttons - FIXED -->
    <div class="ac-button-row">
      <button id="callbackBtn" class="ac-hard-btn" title="Request a callback at a time that suits you">üìû Request Callback</button>
      <button id="sponsorBtn" class="ac-hard-btn" title="Get a personalised email introduction to our preferred clearance sponsor">üìß Get Sponsored</button>
      <button id="humanBtn" class="ac-hard-btn" title="Connect with a live consultant right now">üë§ Speak to Someone</button>
    </div>

    <!-- Input Area - FIXED, ALWAYS VISIBLE -->
    <div class="ac-input-area">
      <input type="text" class="ac-input" id="userInput" placeholder="Type your message...">
      <button class="ac-send" id="sendBtn">Send</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(function() {
  const SUPABASE_URL = "https://qraxdkzmteogkbfatvir.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFyYXhka3ptdGVvZ2tiZmF0dmlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1OTk5MjEsImV4cCI6MjA3OTE3NTkyMX0.WqCGjBEiLgmqbaGmc8Z87CeqY-l_DBR3Gj9VQ4sujks";
  const AI_ENDPOINT = "https://admin-dashboard-rho-lovat-77.vercel.app/api/ai";
  const QUEUE_STATUS_ENDPOINT = "https://admin-dashboard-rho-lovat-77.vercel.app/api/queue/status";
  const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  marked.setOptions({ breaks: true, gfm: true });

  var sessionId = null;
  var userName = '';
  var userFullName = '';
  var userEmail = '';
  var userMobile = '';
  var clearanceLevel = '';
  var isOpen = false;
  var emailValid = false;
  var emailTimeout = null;
  var queuePollInterval = null;
  var queueActive = false;
  var humanRequested = false;
  var introRequested = false;
  var callbackRequested = false;

  var launcher = document.getElementById('launcher');
  var chatWindow = document.getElementById('window');
  var closeBtn = document.getElementById('closeBtn');
  var prechat = document.getElementById('prechat');
  var chat = document.getElementById('chat');
  var startBtn = document.getElementById('startBtn');
  var nameInput = document.getElementById('nameInput');
  var emailInput = document.getElementById('emailInput');
  var mobileInput = document.getElementById('mobileInput');
  var clearanceLevelInput = document.getElementById('clearanceLevel');
  var messages = document.getElementById('messages');
  var userInput = document.getElementById('userInput');
  var sendBtn = document.getElementById('sendBtn');
  var typing = document.getElementById('typing');
  var trafficLight = document.getElementById('trafficLight');
  var redLight = document.getElementById('redLight');
  var yellowLight = document.getElementById('yellowLight');
  var greenLight = document.getElementById('greenLight');
  var trafficStatus = document.getElementById('trafficStatus');
  var bookingOverlay = document.getElementById('bookingOverlay');
  var bookingFrame = document.getElementById('bookingFrame');
  var closeBookingBtn = document.getElementById('closeBooking');

  // Business hours check (Adelaide time) including public holidays
  function isWithinBusinessHours() {
    var now = new Date();
    var adelaide = new Date(now.toLocaleString("en-US", { timeZone: "Australia/Adelaide" }));
    var day = adelaide.getDay(); // 0 = Sunday, 6 = Saturday
    var hour = adelaide.getHours();
    
    // Weekend check
    if (day === 0 || day === 6) return false;
    
    // Public holidays (Australian + SA)
    var dateStr = adelaide.toISOString().split('T')[0]; // YYYY-MM-DD
    var publicHolidays = [
      // National 2025
      '2025-01-01', '2025-01-27', '2025-04-18', '2025-04-19', '2025-04-21', 
      '2025-04-25', '2025-12-25', '2025-12-26',
      // SA 2025
      '2025-03-10', '2025-06-09', '2025-10-06', '2025-12-24', '2025-12-31',
      // National 2026
      '2026-01-01', '2026-01-26', '2026-04-03', '2026-04-04', '2026-04-06',
      '2026-04-27', '2026-12-25', '2026-12-28',
      // SA 2026
      '2026-03-09', '2026-06-08', '2026-10-05', '2026-12-24', '2026-12-31'
    ];
    
    if (publicHolidays.indexOf(dateStr) !== -1) return false;
    
    // Before 9am or after 5pm (7pm on Christmas/NY Eve)
    var isSpecialEve = dateStr.endsWith('-12-24') || dateStr.endsWith('-12-31');
    var closingHour = isSpecialEve ? 19 : 17;
    if (hour < 9 || hour >= closingHour) return false;
    
    // Within business hours (Mon-Fri 9am-5pm/7pm)
    return true;
  }


  // Draggable window
  var isDragging = false;
  var currentX, currentY, initialX, initialY, xOffset = 0, yOffset = 0;
  var dragHandle = document.querySelector('.ac-header');

  dragHandle.addEventListener('mousedown', dragStart);
  document.addEventListener('mousemove', drag);
  document.addEventListener('mouseup', dragEnd);
  dragHandle.addEventListener('touchstart', dragStart);
  document.addEventListener('touchmove', drag);
  document.addEventListener('touchend', dragEnd);

  function dragStart(e) {
    if (e.type === "touchstart") {
      initialX = e.touches[0].clientX - xOffset;
      initialY = e.touches[0].clientY - yOffset;
    } else {
      initialX = e.clientX - xOffset;
      initialY = e.clientY - yOffset;
    }
    if (e.target === dragHandle || dragHandle.contains(e.target)) {
      isDragging = true;
      dragHandle.style.cursor = 'grabbing';
    }
  }

  function drag(e) {
    if (isDragging) {
      e.preventDefault();
      if (e.type === "touchmove") {
        currentX = e.touches[0].clientX - initialX;
        currentY = e.touches[0].clientY - initialY;
      } else {
        currentX = e.clientX - initialX;
        currentY = e.clientY - initialY;
      }
      xOffset = currentX;
      yOffset = currentY;
      setTranslate(currentX, currentY, chatWindow);
    }
  }

  function dragEnd(e) {
    initialX = currentX;
    initialY = currentY;
    isDragging = false;
    dragHandle.style.cursor = 'grab';
  }

  function setTranslate(xPos, yPos, el) {
    el.style.transform = "translate3d(" + xPos + "px, " + yPos + "px, 0)";
  }

  dragHandle.style.cursor = 'grab';
  dragHandle.style.userSelect = 'none';

  // Booking form
  closeBookingBtn.addEventListener('click', function() {
    bookingOverlay.classList.remove('active');
    bookingFrame.src = '';
  });

  function openBookingForm() {
    var bookingUrl = 'https://portal.ausclear.au/bookings.html';
    var params = new URLSearchParams();
    if (userFullName) params.append('name', userFullName);
    if (userEmail) params.append('email', userEmail);
    if (userMobile) params.append('mobile', userMobile);
    if (params.toString()) bookingUrl += '?' + params.toString();
    bookingFrame.src = bookingUrl;
    bookingOverlay.classList.add('active');
  }

  // Traffic light
  function showTrafficLight(color) {
    trafficLight.classList.add('active');
    redLight.classList.remove('red', 'active');
    yellowLight.classList.remove('yellow', 'active');
    greenLight.classList.remove('green', 'active');
    if (color === 'red') {
      redLight.classList.add('red', 'active');
      trafficStatus.textContent = 'All consultants are currently assisting other clients';
    } else if (color === 'yellow') {
      yellowLight.classList.add('yellow', 'active');
      trafficStatus.textContent = "You are in the queue. Estimated wait: ~5 minutes";
    } else if (color === 'green') {
      greenLight.classList.add('green', 'active');
      trafficStatus.textContent = 'Connecting you with a consultant...';
    }
  }

  function hideTrafficLight() {
    trafficLight.classList.remove('active');
    stopQueuePolling();
  }

  function startQueuePolling() {
    if (queuePollInterval) return;
    queueActive = true;
    checkQueueStatus();
    queuePollInterval = setInterval(checkQueueStatus, 30000);
  }

  function stopQueuePolling() {
    if (queuePollInterval) {
      clearInterval(queuePollInterval);
      queuePollInterval = null;
    }
    queueActive = false;
  }

  async function checkQueueStatus() {
    if (!sessionId || !queueActive) return;
    try {
      const res = await fetch(QUEUE_STATUS_ENDPOINT + '?sessionId=' + sessionId);
      if (!res.ok) return;
      const data = await res.json();
      if (data.status === 'not_queued') { hideTrafficLight(); return; }
      if (data.status === 'timeout') {
        showTrafficLight('red');
        addMessage('system', data.message || 'You\'ve been waiting for over 15 minutes.', null, [
          { label: 'Continue Waiting', value: 'CONTINUE_WAITING' },
          { label: 'Request a Callback', value: 'REQUEST_CALLBACK' },
          { label: 'Request Email Introduction', value: 'REQUEST_INTRO' },
          { label: 'Continue with Trigger', value: 'CONTINUE_WITH_TRIGGER' }
        ]);
        stopQueuePolling();
        return;
      }
      if (data.status === 'queued' || data.status === 'waiting') showTrafficLight(data.trafficLight);
    } catch (err) {
      console.error('Queue status check error:', err);
    }
  }

  // Email validation
  var emailValidator = {
    cache: {},
    apiUrl: 'https://portal.ausclear.au/api/validate-email',
    validateEmail: async function(email) {
      if (this.cache[email]) return this.cache[email];
      var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        var result = { isValid: false, message: 'Invalid email format' };
        this.cache[email] = result;
        return result;
      }
      try {
        var response = await fetch(this.apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: email })
        });
        if (!response.ok) throw new Error('HTTP error! status: ' + response.status);
        var result = await response.json();
        this.cache[email] = result;
        return result;
      } catch (error) {
        console.error('Email validation error:', error);
        var result = { isValid: true, message: 'Format valid (verification service unavailable)' };
        this.cache[email] = result;
        return result;
      }
    }
  };

  function showEmailStatus(status, message) {
    var validation = document.getElementById('emailValidation');
    var spinner = document.getElementById('emailSpinner');
    var check = document.getElementById('emailCheck');
    var error = document.getElementById('emailError');
    var text = document.getElementById('emailText');
    spinner.style.display = 'none';
    check.style.display = 'none';
    error.style.display = 'none';
    validation.className = 'ac-validation';
    emailInput.classList.remove('valid', 'invalid');
    if (status === 'checking') {
      validation.className = 'ac-validation checking';
      spinner.style.display = 'inline';
      text.textContent = 'Verifying email address...';
    } else if (status === 'valid') {
      validation.className = 'ac-validation valid';
      check.style.display = 'inline';
      emailInput.classList.add('valid');
      text.textContent = message || 'Email verified';
      emailValid = true;
    } else if (status === 'invalid') {
      validation.className = 'ac-validation invalid';
      error.style.display = 'inline';
      emailInput.classList.add('invalid');
      text.textContent = message || 'Invalid email';
      emailValid = false;
    } else {
      validation.className = 'ac-validation';
      emailValid = false;
    }
    updateStartButton();
  }

  async function checkEmail() {
    var email = emailInput.value.trim();
    if (!email) { showEmailStatus('hide'); return; }
    showEmailStatus('checking', 'Verifying email address...');
    try {
      var result = await emailValidator.validateEmail(email);
      showEmailStatus(result.isValid ? 'valid' : 'invalid', result.message);
    } catch (error) {
      showEmailStatus('invalid', 'Validation error - please check email format');
    }
  }

  function updateStartButton() {
    var nameOk = nameInput.value.trim().length > 0;
    var emailOk = emailValid;
    var clearanceOk = clearanceLevelInput.value.length > 0;
    startBtn.disabled = !(nameOk && emailOk && clearanceOk);
  }

  nameInput.addEventListener('input', updateStartButton);
  clearanceLevelInput.addEventListener('change', updateStartButton);
  emailInput.addEventListener('input', function() {
    clearTimeout(emailTimeout);
    emailTimeout = setTimeout(function() { checkEmail(); }, 800);
    updateStartButton();
  });
  emailInput.addEventListener('blur', function() { checkEmail(); });

  // Launcher
  launcher.addEventListener('click', function() {
    if (isOpen) { closeChat(); } else { openChat(); }
  });
  closeBtn.addEventListener('click', closeChat);

  function openChat() {
    chatWindow.classList.add('open');
    isOpen = true;
    launcher.innerHTML = '<svg viewBox="0 0 24 24" style="width:32px;height:32px;fill:#f1c40f"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>';
  }

  function closeChat() {
    chatWindow.classList.remove('open');
    isOpen = false;
    launcher.innerHTML = '<svg viewBox="0 0 24 24" style="width:32px;height:32px;fill:#f1c40f"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/><circle cx="8" cy="10" r="1.5"/><circle cx="12" cy="10" r="1.5"/><circle cx="16" cy="10" r="1.5"/></svg>';
  }

  function subscribeToSessionChanges() {
    if (!sessionId) return;
    supabaseClient
      .channel('session-' + sessionId)
      .on('postgres_changes', {
          event: 'UPDATE',
          schema: 'public',
          table: 'live_chat_sessions',
          filter: 'id=eq.' + sessionId
        },
        function(payload) {
          var data = payload.new;
          if (data.handover_status === 'queued' && data.queued_at) {
            showTrafficLight('yellow');
            startQueuePolling();
          }
          if (data.handover_status === 'accepted' && data.assigned_operator) {
            hideTrafficLight();
            stopQueuePolling();
          }
        }
      )
      .subscribe();
  }

  async function loadPreviousConversationSummary() {
    if (!sessionId || !userEmail) return false;
    try {
      const { data: previousSessions } = await supabaseClient
        .from('live_chat_sessions')
        .select('conversation_summary, created_at, intake_clearance_type')
        .eq('user_email', userEmail.toLowerCase().trim())
        .neq('id', sessionId)
        .not('conversation_summary', 'is', null)
        .order('created_at', { desc: true })
        .limit(5);

      if (!previousSessions || previousSessions.length === 0) return false;

      const mostRecent = previousSessions[0];
      const date = new Date(mostRecent.created_at).toLocaleDateString('en-AU', {
        day: 'numeric',
        month: 'short',
        year: 'numeric'
      });
      
      const clearanceType = mostRecent.intake_clearance_type || 'Not specified';
      
      let summaryText = '';
      if (previousSessions.length === 1) {
        summaryText = previousSessions[0].conversation_summary;
      } else {
        summaryText = '**Recent conversations:**\n\n';
        previousSessions.forEach((session, idx) => {
          const sessionDate = new Date(session.created_at).toLocaleDateString('en-AU', {
            day: 'numeric',
            month: 'short'
          });
          summaryText += `${idx + 1}. ${sessionDate}: ${session.conversation_summary}\n\n`;
        });
      }
      
      const summaryMessage = `**Welcome back!** üëã\n\n**Last conversation:** ${date}\n\n${summaryText}**Primary Clearance Level:** ${clearanceType}\n\nHow can I help you today?`;
      
      addMessage('system', summaryMessage);
      return true;
    } catch (err) {
      console.error('Failed to load previous conversation:', err);
      return false;
    }
  }

  // Start chat
  startBtn.addEventListener('click', async function() {
    var name = nameInput.value.trim();
    var email = emailInput.value.trim();
    var mobile = mobileInput.value.trim();
    if (!name || !email) {
      alert('Please complete all required fields.');
      return;
    }

    var nameParts = name.split(' ');
    var firstName = nameParts[0].charAt(0).toUpperCase() + nameParts[0].slice(1).toLowerCase();
    var fullName;
    if (nameParts.length > 1) {
      var surname = nameParts.slice(1).join(' ').toUpperCase();
      fullName = firstName + ' ' + surname;
    } else {
      fullName = firstName;
    }

    userName = firstName;
    userFullName = fullName;
    userEmail = email;
    userMobile = mobile;
    clearanceLevel = clearanceLevelInput.value;

    const { data, error } = await supabaseClient
      .from("live_chat_sessions")
      .insert({
        user_name: firstName,
        full_name: fullName,
        email: email,
        user_email: email.toLowerCase().trim(),
        mobile_number: mobile || null,
        query_type: "General",
        intake_clearance_type: clearanceLevel,
        status: "open",
        channel: "web",
        user_agent: navigator.userAgent,
        referrer_url: document.referrer || window.location.href
      })
      .select()
      .single();

    if (error) {
      alert("Failed to create session. Please try again.");
      console.error(error);
      return;
    }

    sessionId = data.id;
    window.currentSessionId = sessionId;

    subscribeToAdminMessages(sessionId);
    subscribeToSessionUpdates(sessionId);
    subscribeToSessionChanges();

    prechat.style.display = 'none';
    chat.classList.add('active');
    
    // Set initial button state based on business hours
    if (!isWithinBusinessHours()) {
      var humanBtn = document.getElementById('humanBtn');
      humanBtn.disabled = true;
      humanBtn.style.opacity = '0.5';
      humanBtn.style.cursor = 'not-allowed';
      humanBtn.title = 'Available Mon-Fri 9am-5pm Adelaide time';
    }

    setTimeout(function() {
      showTyping();
      setTimeout(async function() {
        hideTyping();
        const hasPreviousSummary = await loadPreviousConversationSummary();
        if (!hasPreviousSummary) {
          sendToAssistant("__FIRST_MESSAGE__");
        }
        userInput.focus();
      }, 800);
    }, 300);
  });

  function subscribeToAdminMessages(currentSessionId) {
    supabaseClient
      .channel('widget-chat-feed-' + currentSessionId)
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'live_chat_messages' },
        function(payload) {
          if (payload.new.session_id === currentSessionId) {
            var senderType = payload.new.sender_type;
            if (senderType === 'admin') {
              var adminName = payload.new.sender_name || 'Clearance First Support';
              hideTyping();
              hideTrafficLight();
              addMessage('admin', payload.new.message_text, adminName);
            }
            if (senderType === 'system') {
              hideTyping();
              var buttons = payload.new.message_metadata?.buttons || null;
              addMessage('system', payload.new.message_text, 'Clearance First Support', buttons);
            }
          }
        }
      )
      .subscribe();
  }

  function subscribeToSessionUpdates(currentSessionId) {
    supabaseClient
      .channel('widget-session-updates-' + currentSessionId)
      .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'live_chat_sessions', filter: 'id=eq.' + currentSessionId },
        function(payload) {
          var session = payload.new;
          
          // Store session for button state checks
          window.currentSession = session;
          
          if (session.human_requested !== humanRequested) {
            humanRequested = session.human_requested;
            updateHumanButtonState();
          }
          
          if (session.intro_sent) {
            introRequested = true;
            updateIntroButtonState(true);
          } else if (session.intro_requested && !introRequested) {
            introRequested = true;
            updateIntroButtonState(false);
          }
          
          if (session.booking_requested && !callbackRequested) {
            callbackRequested = true;
            updateCallbackButtonState();
          }
          
          if (session.human_requested && !session.assigned_operator) {
            if (!queueActive) {
              showTrafficLight('green');
              startQueuePolling();
            }
          }
          if (session.handover_status === 'queued' && session.queued_at) {
            if (!queueActive) startQueuePolling();
          }
          if (session.assigned_operator && session.ai_active === false) {
            hideTrafficLight();
            resetHumanRequest();
          }
        }
      )
      .subscribe()
  }

  function saveMessage(senderType, senderName, text) {
    if (!sessionId) return;
    supabaseClient.from('live_chat_messages').insert([{
      session_id: sessionId,
      sender_type: senderType,
      sender_name: senderName,
      message_text: text
    }]);
  }

  function handleButtonClick(buttonValue, buttonLabel) {
    document.querySelectorAll('.ac-action-btn').forEach(function(btn) {
      btn.disabled = true;
    });
    addMessage('user', buttonLabel);
    saveMessage('user', userFullName, buttonValue);
    
    if (buttonValue === 'BOOK_CALL' || buttonValue === 'REQUEST_CALLBACK') {
      hideTrafficLight();
      stopQueuePolling();
      callbackRequested = true;
      updateCallbackButtonState();
      if (sessionId) {
        supabaseClient
          .from('live_chat_sessions')
          .update({ booking_requested: true })
          .eq('id', sessionId);
      }
      openBookingForm();
    } else if (buttonValue === 'REQUEST_INTRO') {
      hideTrafficLight();
      stopQueuePolling();
      introRequested = true;
      updateIntroButtonState(false);
      showTyping();
      sendToAssistant(buttonValue);
    } else if (buttonValue === 'SPEAK_HUMAN' || buttonValue === 'SPEAK_TO_SOMEONE') {
      if (!sessionId) {
        addMessage('system', 'Session not started');
        return;
      }
      
      // CHECK BUSINESS HOURS BEFORE ALLOWING REQUEST
      if (!isWithinBusinessHours()) {
        addMessage('system', '**Our consultants are available Monday to Friday, 9am-5pm Adelaide time.**\n\nSince we\'re currently outside business hours, here are your options:', null, [
          { label: 'Request a Callback', value: 'REQUEST_CALLBACK', tooltip: 'We\'ll call you back during business hours' },
          { label: 'Request Email Introduction', value: 'REQUEST_INTRO', tooltip: 'Get a personalised email introduction to our preferred sponsor' },
          { label: 'Continue with Trigger', value: 'CONTINUE_WITH_TRIGGER', tooltip: 'Keep chatting with our AI assistant' }
        ]);
        return;
      }
      
      if (humanRequested) {
        addMessage('system', 'A human operator has already been notified.');
        return;
      }
      humanRequested = true;
      updateHumanButtonState();
      supabaseClient
        .from('live_chat_sessions')
        .update({ human_requested: true })
        .eq('id', sessionId)
        .then(function(res) {
          if (res.error) {
            console.error('Failed to request human:', res.error);
            humanRequested = false;
            updateHumanButtonState();
          } else {
            addMessage('system', 'üë§ Connecting you with a consultant. Please wait...');
            showTrafficLight('green');
            startQueuePolling();
          }
        });
    } else if (buttonValue === 'CONTINUE_WAITING') {
      hideTrafficLight();
      addMessage('system', 'Thank you for your patience.');
      startQueuePolling();
    } else if (buttonValue === 'CONTINUE_WITH_TRIGGER') {
      hideTrafficLight();
      stopQueuePolling();
      resetHumanRequest();
      showTyping();
      sendToAssistant(buttonValue);
    } else {
      showTyping();
      sendToAssistant(buttonValue);
    }
  }

  async function sendToAssistant(msg) {
    try {
      const res = await fetch(AI_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          sessionId: sessionId,
          message: msg,
          name: userFullName,
          email: userEmail
        })
      });
      
      hideTyping();
      
      if (!res.ok) {
        addMessage("system", "‚ùå Server error " + res.status);
        return;
      }
      
      const data = await res.json();
      
      if (!data.reply || data.mode === 'human_active') {
        return;
      }
      
      addMessage("ai", data.reply, null, data.buttons || null);
    } catch (err) {
      hideTyping();
      addMessage("system", "üî• Error: " + err.message);
      console.error(err);
    }
  }

  function addMessage(sender, text, senderName, buttons) {
    var div = document.createElement('div');
    div.className = 'ac-msg ' + sender;
    var content = document.createElement('div');
    content.className = 'ac-msg-content';
    var nameLabel = '';
    if (sender === 'ai') nameLabel = '<div class="ac-sender-name">Trigger</div>';
    else if (sender === 'admin') nameLabel = '<div class="ac-sender-name">' + (senderName || 'Clearance First Support') + '</div>';
    else if (sender === 'system') nameLabel = '<div class="ac-sender-name">Clearance First Support</div>';
    else if (sender === 'user') nameLabel = '<div class="ac-sender-name">' + userFullName + '</div>';
    var messageHtml;
    if (sender === 'ai' || sender === 'admin' || sender === 'system') {
      messageHtml = marked.parse(text);
    } else {
      messageHtml = text.replace(/\n/g, '<br>');
    }
    content.innerHTML = nameLabel + messageHtml;
    if ((sender === 'ai' || sender === 'system') && buttons && Array.isArray(buttons) && buttons.length > 0) {
      var buttonsDiv = document.createElement('div');
      buttonsDiv.className = 'ac-action-buttons';
      buttons.forEach(function(btn) {
        var button = document.createElement('button');
        button.className = 'ac-action-btn';
        button.textContent = btn.label;
        if (btn.disabled === true) {
          button.disabled = true;
          button.title = btn.tooltip || 'Unavailable';
        } else if (btn.tooltip) {
          button.title = btn.tooltip;
        }
        button.addEventListener('click', function() {
          if (!btn.disabled) {
            handleButtonClick(btn.value, btn.label);
          }
        });
        buttonsDiv.appendChild(button);
      });
      content.appendChild(buttonsDiv);
    }
    div.appendChild(content);
    messages.insertBefore(div, typing);
    messages.scrollTop = messages.scrollHeight;
  }

  function showTyping() { typing.classList.add('active'); messages.scrollTop = messages.scrollHeight; }
  function hideTyping() { typing.classList.remove('active'); }

  function sendTypingState(isTyping) {
    if (!sessionId) return;
    supabaseClient
      .from('live_chat_sessions')
      .update({
        typing: isTyping,
        typing_name: userFullName,
        typing_updated_at: new Date().toISOString()
      })
      .eq('id', sessionId);
  }

  function sendMessage() {
    var text = userInput.value.trim();
    if (!text) return;
    userInput.value = '';
    sendTypingState(false);
    clearTimeout(window._typingTimeout);
    addMessage('user', text);
    saveMessage('user', userFullName, text);
    showTyping();
    sendToAssistant(text);
  }

  userInput.addEventListener('input', function() {
    if (!sessionId) return;
    sendTypingState(true);
    clearTimeout(window._typingTimeout);
    window._typingTimeout = setTimeout(function() {
      sendTypingState(false);
    }, 1200);
  });

  sendBtn.addEventListener('click', sendMessage);
  userInput.addEventListener('keypress', function(e) { if (e.key === 'Enter') sendMessage(); });

  function updateHumanButtonState() {
    var btn = document.getElementById('humanBtn');
    if (!btn) return;
    
    // Check if human operator is currently active
    if (window.currentSession && window.currentSession.ai_active === false && window.currentSession.assigned_operator) {
      btn.disabled = true;
      btn.style.opacity = '0.6';
      btn.style.cursor = 'not-allowed';
      btn.style.background = '#f5f5f5';
      btn.style.borderColor = '#ccc';
      btn.style.color = '#666';
      btn.textContent = 'üë§ Operator Active';
      btn.title = window.currentSession.assigned_operator + ' is currently assisting you';
      return;
    }
    
    // Check business hours
    var isOpen = isWithinBusinessHours();
    
    if (humanRequested) {
      btn.disabled = true;
      btn.style.opacity = '0.6';
      btn.style.cursor = 'not-allowed';
      btn.style.background = '#f5f5f5';
      btn.style.borderColor = '#ccc';
      btn.style.color = '#666';
      btn.textContent = queueActive ? '‚è≥ In queue...' : '‚è≥ Connecting...';
    } else if (!isOpen) {
      // OUTSIDE BUSINESS HOURS - KEEP DISABLED
      btn.disabled = true;
      btn.style.opacity = '0.5';
      btn.style.cursor = 'not-allowed';
      btn.style.background = '#f5f5f5';
      btn.style.borderColor = '#ccc';
      btn.style.color = '#999';
      btn.textContent = 'üë§ Speak to Someone';
      btn.title = 'Available Mon-Fri 9am-5pm Adelaide time (excluding public holidays)';
    } else {
      // WITHIN BUSINESS HOURS - ENABLE
      btn.disabled = false;
      btn.style.opacity = '1';
      btn.style.cursor = 'pointer';
      btn.style.background = 'var(--white)';
      btn.style.borderColor = 'var(--navy-primary)';
      btn.style.color = 'var(--navy-primary)';
      btn.textContent = 'üë§ Speak to Someone';
      btn.title = 'Connect with a live consultant right now';
    }
  }

  function updateIntroButtonState(sent) {
    var btn = document.getElementById('sponsorBtn');
    if (!btn) return;
    if (sent) {
      btn.disabled = true;
      btn.style.opacity = '0.7';
      btn.style.background = '#e8f5e9';
      btn.style.borderColor = '#4caf50';
      btn.style.color = '#2e7d32';
      btn.textContent = '‚úâÔ∏è Introduction Sent';
    } else if (introRequested) {
      btn.disabled = true;
      btn.style.opacity = '0.7';
      btn.style.background = '#fff3e0';
      btn.style.borderColor = '#ff9800';
      btn.style.color = '#e65100';
      btn.textContent = '‚úÖ Introduction Requested';
    } else {
      btn.disabled = false;
      btn.style.opacity = '1';
      btn.style.background = 'var(--white)';
      btn.style.borderColor = 'var(--navy-primary)';
      btn.style.color = 'var(--navy-primary)';
      btn.textContent = 'üìß Get Sponsored';
    }
  }

  function updateCallbackButtonState() {
    var btn = document.getElementById('callbackBtn');
    if (!btn) return;
    if (callbackRequested) {
      btn.disabled = true;
      btn.style.opacity = '0.7';
      btn.style.background = '#e8f5e9';
      btn.style.borderColor = '#4caf50';
      btn.style.color = '#2e7d32';
      btn.textContent = '‚úÖ Callback Scheduled';
    } else {
      btn.disabled = false;
      btn.style.opacity = '1';
      btn.style.background = 'var(--white)';
      btn.style.borderColor = 'var(--navy-primary)';
      btn.style.color = 'var(--navy-primary)';
      btn.textContent = 'üìû Request Callback';
    }
  }

  function resetHumanRequest() {
    humanRequested = false;
    updateHumanButtonState();
  }

  // Hard-coded button handlers
  document.getElementById('callbackBtn').addEventListener('click', function() {
    if (callbackRequested) {
      addMessage('system', 'You have already requested a callback.');
      return;
    }
    callbackRequested = true;
    updateCallbackButtonState();
    if (sessionId) {
      supabaseClient
        .from('live_chat_sessions')
        .update({ booking_requested: true })
        .eq('id', sessionId);
    }
    openBookingForm();
  });

  document.getElementById('sponsorBtn').addEventListener('click', async function() {
    if (introRequested) {
      addMessage('system', 'You have already requested an introduction.');
      return;
    }
    if (!userEmail) {
      addMessage('system', 'Email address required.');
      return;
    }
    introRequested = true;
    updateIntroButtonState(false);
    if (sessionId) {
      supabaseClient
        .from('live_chat_sessions')
        .update({ intro_requested: true })
        .eq('id', sessionId);
    }
    addMessage('system', 'Introduction requested. Our team will send you a personalised email introduction to our preferred clearance sponsor shortly.');
  });

  document.getElementById('humanBtn').addEventListener('click', function() {
    if (!sessionId) {
      addMessage('system', 'Please start a conversation first.');
      return;
    }
    
    // CHECK BUSINESS HOURS - SHOW MODAL WITH OPTIONS
    if (!isWithinBusinessHours()) {
      addMessage('system', '**Our consultants are available Monday to Friday, 9am-5pm Adelaide time.**\n\nSince we\'re currently outside business hours, here are your options:', null, [
        { label: 'Request a Callback', value: 'REQUEST_CALLBACK', tooltip: 'We\'ll call you back during business hours' },
        { label: 'Request Email Introduction', value: 'REQUEST_INTRO', tooltip: 'Get a personalised email introduction to our preferred sponsor' },
        { label: 'Continue with Trigger', value: 'CONTINUE_WITH_TRIGGER', tooltip: 'Keep chatting with our AI assistant' }
      ]);
      return;
    }
    
    if (humanRequested) {
      addMessage('system', 'A consultant has already been notified.');
      return;
    }
    humanRequested = true;
    updateHumanButtonState();
    supabaseClient
      .from('live_chat_sessions')
      .update({ human_requested: true })
      .eq('id', sessionId)
      .then(function(res) {
        if (res.error) {
          console.error('Failed to request human:', res.error);
          humanRequested = false;
          updateHumanButtonState();
          addMessage('system', 'Unable to connect. Please try again.');
        } else {
          addMessage('system', 'Connecting you with a consultant. Please wait...');
          showTrafficLight('green');
          startQueuePolling();
        }
      });
  });

})();
</script>
</body>
</html>




